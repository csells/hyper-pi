{
  "prd": "(prompt)",
  "prompt": "## Mobile Features Plan for Pi-DE\n\nImplement the mobile features from TODO.md for the Pi-DE React web dashboard. The Pi-DE codebase is in `pi-de/`. The project uses React + Vite + TypeScript with `@mariozechner/pi-web-ui` Lit web components for rendering agent conversations.\n\n### Current State\n- Pi-DE has a 2-column grid layout (sidebar roster + main chat stage) in `pi-de/src/App.tsx` and `pi-de/src/App.css`\n- Mobile CSS media queries exist at the bottom of `App.css` but are incomplete — they define `.agent-selected` class toggling but `App.tsx` never applies that class\n- Touch-friendly 44px tap targets already exist (R-UI-4 satisfied)\n- `pi-socket/src/history.ts` already truncates init_state to 500KB and sends `truncated: true` + `totalMessages` — but there is NO pagination/fetch-older-messages endpoint yet\n- The `<agent-interface>` web component from pi-web-ui handles the message rendering and input editor\n\n### Features to implement (from TODO.md mobile section)\n\n**Feature 1: Responsive mobile layout (roster to chat navigation)**\n- On mobile (<768px), show roster list as full-screen page\n- Clicking an agent navigates to a full-screen chat view\n- A back button in the chat header returns to the roster\n- Must toggle the `.agent-selected` class on `.pi-de-layout` (or use React state) so the existing CSS media queries work\n- The CSS already has the rules for `.pi-de-layout.agent-selected .roster-pane { display: none }` etc.\n\n**Feature 2: Mobile virtual keyboard (VKB) behavior**\n- On mobile, Enter key in the virtual keyboard should insert a newline in the prompt textarea (NOT submit)\n- A visible Submit button sends the prompt\n- This requires patching or configuring the `<agent-interface>` web component's `MessageEditor` behavior\n- Need to detect mobile via viewport width or touch capability\n- The `<agent-interface>` component comes from pi-web-ui — we may need to patch its `sendMessage` or intercept keydown events on the shadow DOM textarea\n\n**Feature 3: Lazy message loading / infinite scroll back**\n- Load only the most recent N messages on agent connect\n- When user scrolls to the top, fetch older messages from pi-socket\n- Requires NEW protocol: a `fetch_history` request/response in pi-socket (request: `{ type: \"fetch_history\", before: number, limit: number }`, response: `{ type: \"history_page\", messages: AgentMessage[], hasMore: boolean }`)\n- Pi-DE's `RemoteAgent` needs to support prepending older messages\n- Need scroll detection on the `<agent-interface>` container to trigger loading\n- The `hyper-pi-protocol` package needs new types for the pagination protocol\n\n**Feature 4: Cloudflare tunnel setup**\n- Set up a CF tunnel configuration so Pi-DE can be accessed from mobile devices on different networks\n- This is infrastructure/docs, not code in the app itself\n- Document the `cloudflared tunnel` setup for accessing the hypivisor\n\n### Key Constraints\n- `pi` itself is NEVER modified (per AGENTS.md)\n- pi-web-ui is a dependency, not owned — patches must be external\n- Tests are required (vitest for pi-de and pi-socket, integration tests for the full stack)\n- The `hyper-pi-protocol` package is the single source of truth for wire types\n- Existing tests must continue to pass\n\n### Codebase References\n- `pi-de/src/App.tsx` — main layout component\n- `pi-de/src/App.css` — all styles including mobile media queries\n- `pi-de/src/useAgent.ts` — agent connection hook\n- `pi-de/src/RemoteAgent.ts` — WebSocket adapter (duck-types pi Agent)\n- `pi-de/src/types.ts` — re-exports from hyper-pi-protocol\n- `pi-socket/src/history.ts` — buildInitState with truncation\n- `pi-socket/src/index.ts` — WebSocket server handler\n- `hyper-pi-protocol/src/index.ts` — shared wire types\n- `specs/requirements.md` — R-UI-3 (mobile layout), R-UI-4 (touch targets)\n- Each component has its own AGENTS.md with build/test commands",
  "created_at": "2026-02-24T01:05:26.134Z",
  "updated_at": "2026-02-24T01:21:30.327Z",
  "task_count": 5,
  "completed_count": 4
}